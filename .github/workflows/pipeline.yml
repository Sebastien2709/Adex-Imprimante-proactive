name: Pipeline quotidien

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      TENANT_ID:                ${{ secrets.TENANT_ID }}
      CLIENT_ID:                ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET:            ${{ secrets.CLIENT_SECRET }}
      SHAREPOINT_SITE_URL:      ${{ secrets.SHAREPOINT_SITE_URL }}
      SHAREPOINT_LIBRARY_NAME:  ${{ secrets.SHAREPOINT_LIBRARY_NAME }}
      SHAREPOINT_FOLDER_PATH:   ${{ secrets.SHAREPOINT_FOLDER_PATH }}
      LOCAL_DATA_DIR:           ./data/raw/xrm
      SUPABASE_URL:             ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY:             ${{ secrets.SUPABASE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Installer les dependances
        run: pip install -r requirements.render.txt msal

      - name: Creer les dossiers data
        run: |
          mkdir -p data/raw/xrm
          mkdir -p data/interim
          mkdir -p data/processed
          mkdir -p data/outputs

      - name: Telecharger donnees SharePoint
        run: python download_xrm_filtered.py

      - name: Debug fichiers telecharges
        run: |
          echo "=== data/raw/xrm ==="
          ls -la data/raw/xrm/ || echo "(vide)"

      - name: Ingest
        run: python -m src.data.ingest

      - name: Clean KPAX consumables
        run: python -m src.data.clean_kpax_consumables

      - name: Clean meters
        run: python -m src.data.clean_meters

      - name: Clean item ledger
        run: python -m src.data.clean_item_ledger

      - name: Load contract status
        run: python src/data/load_contract_status.py

      - name: Detect resets
        run: python -m src.features.detect_resets

      - name: Compute slopes
        run: python -m src.features.compute_slopes

      - name: Train XGB v21
        run: python -m src.model.train_xgb_v21

      - name: Predict XGB v21
        run: python -m src.model.predict_xgb_v21

      - name: Enrich replenishments
        run: python -m src.model.enrich_replenishments_v21

      - name: Export recos business
        run: python -m src.model.export_recos_business

      - name: Make kpax_last_states
        run: python scripts/make_kpax_last_states.py

      - name: Make kpax_history_light
        run: python scripts/make_kpax_history_light.py

      - name: Generer parquet historique
        run: python scripts/gen_history_parquet.py

      - name: Upload vers Supabase
        run: python scripts/upload_to_supabase.py
