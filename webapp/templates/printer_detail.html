<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>üñ®Ô∏è {{ serial_display }} ‚Äî toner.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1117; --surface: #161820; --surface2: #1e2028;
      --border: #2a2d35; --text: #e2e4e9; --text-muted: #7a7f8e;
      --accent: #6c63ff; --red: #ef4444; --orange: #f59e0b; --green: #22c55e;
      --prio1: #ef4444; --prio2: #f59e0b; --prio3: #eab308; --prio4: #22c55e;
    }
    html.light {
      --bg: #f0f2f5; --surface: #ffffff; --surface2: #f4f6f9;
      --border: #dde1e7; --text: #1e2028; --text-muted: #6b7280;
      --accent: #5b52e5; --red: #dc2626; --orange: #d97706; --green: #16a34a;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; margin: 0; transition: background .3s, color .3s; }
    .top-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 2rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .top-bar .logo { font-family: 'DM Mono', monospace; font-weight: 500; font-size: 1rem; color: var(--accent); letter-spacing: 0.04em; }
    .top-bar .logo span { color: var(--text-muted); }
    .top-bar-right { display: flex; align-items: center; gap: 0.6rem; }
    .btn-back { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; padding: 0.3rem 0.75rem; font-size: 0.8rem; text-decoration: none; font-weight: 600; transition: all 0.15s; }
    .btn-back:hover { border-color: var(--accent); color: var(--text); text-decoration: none; }
    .main-wrap { max-width: 1200px; margin: 0 auto; padding: 1.75rem 1.5rem; }

    /* HEADER */
    .page-header {
      background: linear-gradient(135deg, rgba(108,99,255,0.12), rgba(108,99,255,0.04));
      border: 1px solid rgba(108,99,255,0.25); border-radius: 14px;
      padding: 1.25rem 1.5rem; margin-bottom: 1.5rem;
      display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;
    }
    .page-header h1 { margin: 0; font-family: 'DM Mono', monospace; font-size: 1.35rem; font-weight: 600; color: var(--text); }
    .page-header .meta { display: flex; flex-wrap: wrap; gap: 0.9rem; margin-top: 0.5rem; }
    .page-header .meta span { font-size: 0.82rem; color: var(--text-muted); }
    .page-header .meta strong { color: var(--text); font-weight: 600; }
    .badge-prio { display: inline-block; border-radius: 6px; padding: 0.2rem 0.65rem; font-size: 0.82rem; font-weight: 700; color: #fff; }
    .badge-prio-1 { background: var(--prio1); } .badge-prio-2 { background: var(--prio2); }
    .badge-prio-3 { background: var(--prio3); color: #1a1a1a; } .badge-prio-4 { background: var(--prio4); }

    /* CARDS */
    .card-block { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1.25rem; overflow: hidden; }
    .card-block-header { background: var(--surface2); border-bottom: 1px solid var(--border); padding: 0.65rem 1.1rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.07em; }
    .card-block-body { padding: 1rem 1.1rem; }

    /* CHIPS */
    .chips-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 0.35rem 0.75rem; font-size: 0.8rem; display: flex; align-items: center; gap: 0.45rem; }
    .chip .label { color: var(--text-muted); font-size: 0.73rem; }
    .chip .val { font-family: 'DM Mono', monospace; font-weight: 500; color: var(--text); }
    .chip.pct-low  { border-color: rgba(239,68,68,0.4); }
    .chip.pct-mid  { border-color: rgba(245,158,11,0.4); }
    .chip.pct-ok   { border-color: rgba(34,197,94,0.3); }

    /* TABLE */
    .toner-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .toner-table th { background: var(--surface2); color: var(--text-muted); font-weight: 600; font-size: 0.69rem; text-transform: uppercase; letter-spacing: 0.06em; padding: 0.5rem 0.75rem; text-align: left; white-space: nowrap; border-bottom: 1px solid var(--border); }
    .toner-table td { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
    .toner-table tr:last-child td { border-bottom: none; }
    .toner-table tr:hover td { background: rgba(108,99,255,0.04); }

    /* BADGES */
    .badge-inchange { display: inline-flex; align-items: center; gap: 0.3rem; background: rgba(245,158,11,0.14); border: 1px solid rgba(245,158,11,0.35); border-radius: 6px; padding: 0.15rem 0.5rem; font-size: 0.74rem; font-weight: 600; color: var(--orange); }
    .warn-banner { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 0.55rem 0.85rem; font-size: 0.82rem; color: var(--orange); margin-bottom: 0.75rem; display: none; }
    .warn-banner.show { display: block; }

    /* THEME TOGGLE */
    .theme-toggle { display: flex; align-items: center; width: 48px; height: 26px; border-radius: 13px; background: var(--surface2); border: 1.5px solid var(--border); cursor: pointer; padding: 0 2px; transition: background .3s, border-color .3s; }
    .theme-toggle:hover { border-color: var(--accent); }
    .theme-toggle .knob { width: 20px; height: 20px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 12px; line-height: 1; box-shadow: 0 1px 4px rgba(0,0,0,.25); transition: transform .3s cubic-bezier(.4,0,.2,1); }
    html.light .theme-toggle .knob { transform: translateX(22px); }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<nav class="top-bar">
  <div class="logo">toner<span>.</span>ai <span style="font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.82rem;">‚Äî D√©tails imprimante</span></div>
  <div class="top-bar-right">
    <button class="theme-toggle" id="themeToggle" aria-label="Basculer th√®me"><span class="knob" id="themeIcon">üåô</span></button>
    <a href="/" class="btn-back">‚Üê Retour</a>
  </div>
</nav>

<div class="main-wrap">

  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1>üñ®Ô∏è {{ serial_display }}</h1>
      <div class="meta">
        {% if client %}<span><strong>Client</strong> {{ client }}</span>{% endif %}
        {% if city %}<span><strong>Ville</strong> {{ city }}</span>{% endif %}
        {% if contract %}<span><strong>Contrat</strong> {{ contract }}</span>{% endif %}
        {% if min_stockout_date %}<span><strong>Prochaine rupture</strong> {{ min_stockout_date }}</span>{% endif %}
        {% if min_days_left is not none %}<span><strong>Jours min</strong> {{ min_days_left | int }}</span>{% endif %}
      </div>
    </div>
    <div>{% if min_priority is not none %}<span class="badge-prio badge-prio-{{ min_priority }}">P{{ min_priority }}</span>{% endif %}</div>
  </div>

  <!-- KPAX STATUS -->
  <div class="card-block">
    <div class="card-block-header">üìä √âtat des toners (KPAX)</div>
    <div class="card-block-body">
      <div class="chips-row">
        {% for t in kpax_status %}
          {% set dot = "#4b5563" %}
          {% if t.color == "black" %}{% set dot = "#e2e4e9" %}
          {% elif t.color == "cyan" %}{% set dot = "#06b6d4" %}
          {% elif t.color == "magenta" %}{% set dot = "#ec4899" %}
          {% elif t.color == "yellow" %}{% set dot = "#eab308" %}{% endif %}
          {% set cls = "" %}
          {% if t.last_pct is not none %}
            {% if t.last_pct < 15 %}{% set cls = "pct-low" %}
            {% elif t.last_pct < 35 %}{% set cls = "pct-mid" %}
            {% else %}{% set cls = "pct-ok" %}{% endif %}
          {% endif %}
          <div class="chip {{ cls }}">
            <span style="width:9px;height:9px;border-radius:50%;background:{{ dot }};display:inline-block;flex-shrink:0;"></span>
            <span style="font-weight:600;">{{ t.color }}</span>
            <span class="val">{% if t.last_pct is not none %}{{ t.last_pct | round(0) | int }}%{% else %}‚Äî{% endif %}</span>
            <span class="label">{% if t.last_update %}{{ t.last_update }}{% else %}‚Äî{% endif %}</span>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- PENTES -->
  <div class="card-block">
    <div class="card-block-header">üìâ Pentes de consommation (%/jour)</div>
    <div class="card-block-body">
      <div class="chips-row">
        {% for color, dot in [("black","#e2e4e9"),("cyan","#06b6d4"),("magenta","#ec4899"),("yellow","#eab308")] %}
          <div class="chip">
            <span style="width:9px;height:9px;border-radius:50%;background:{{ dot }};display:inline-block;flex-shrink:0;"></span>
            <span class="label">{{ color }}</span>
            <span class="val">
              {% if slopes[color] is not none %}{{ "%.3f" | format(slopes[color]) }} %/j{% else %}‚Äî{% endif %}
            </span>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- GRAPHE -->
  <div class="card-block">
    <div class="card-block-header">üìà Historique consommation</div>
    <div class="card-block-body">
      <div class="warn-banner" id="historyWarn"></div>
      <canvas id="historyChart" style="max-height:260px;"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card-block">
    <div class="card-block-header">üóÇÔ∏è Toners recommand√©s</div>
    <div style="overflow-x:auto;">
      <table class="toner-table">
        <thead>
          <tr>
            <th>ID</th><th>Toner</th><th>Couleur</th><th>Jours rest.</th>
            <th>Date rupture</th><th>Priorit√©</th><th>Derni√®re remont√©e</th>
            <th>%</th><th>Type livraison</th><th>Commentaire</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td style="font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--text-muted);">{{ r.get(col_id, "") }}</td>
            <td><strong>{{ r.get(col_toner, "") }}</strong></td>
            <td>{{ r.get("couleur", "") }}</td>
            <td>
              {% set d = r.get(col_days) %}
              {% if d is not none and d == d %}
                {% if d | float <= 0 %}<span style="color:var(--red);font-weight:700;">{{ d | int }} j ‚ö†Ô∏è</span>
                {% elif d | float <= 7 %}<span style="color:var(--orange);font-weight:600;">{{ d | int }} j</span>
                {% else %}{{ d | int }} j{% endif %}
              {% else %}‚Äî{% endif %}
            </td>
            <td>{{ r.get(col_stockout, "") or "‚Äî" }}</td>
            <td>
              {% set p = r.get(col_priority) %}
              {% if p is not none %}<span class="badge-prio badge-prio-{{ p | int }}">P{{ p | int }}</span>{% endif %}
            </td>
            <td style="font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--text-muted);">{{ r.get(col_last_update, "") or "‚Äî" }}</td>
            <td>
              {% set pct = r.get(col_last_pct) %}
              {% if pct is not none %}
                {% if pct | float < 15 %}<span style="color:var(--red);font-weight:600;">{{ pct | round(0) | int }}%</span>
                {% elif pct | float < 35 %}<span style="color:var(--orange);font-weight:600;">{{ pct | round(0) | int }}%</span>
                {% else %}{{ pct | round(0) | int }}%{% endif %}
              {% endif %}
            </td>
            <td>{{ r.get(col_type_liv, "") }}</td>
            <td>
              {% set cmt = r.get(col_comment, "") | string %}
              {% if "inchang√©" in cmt | lower or "inchange" in cmt | lower %}
                <span class="badge-inchange">üîî Toner inchang√©</span>
                <span style="color:var(--text-muted);font-size:0.73rem;display:block;margin-top:0.2rem;">{{ cmt }}</span>
              {% else %}
                <span style="color:var(--text-muted);">{{ cmt }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function(){
  const KEY = 'tonerai-theme';
  const html = document.documentElement;
  const btn  = document.getElementById('themeToggle');
  const icon = document.getElementById('themeIcon');
  function apply(t){ if(t==='light'){html.classList.add('light');icon.textContent='‚òÄÔ∏è';}else{html.classList.remove('light');icon.textContent='üåô';} }
  apply(localStorage.getItem(KEY)||'dark');
  btn.addEventListener('click',()=>{ const n=html.classList.contains('light')?'dark':'light'; apply(n); localStorage.setItem(KEY,n); });
})();

const serial = {{ serial_display | tojson }};
const warnEl = document.getElementById('historyWarn');
function setWarn(msg){ warnEl.textContent=msg||''; warnEl.classList.toggle('show',!!msg); }

async function loadHistory(){
  try{
    const res = await fetch(`/api/printer_history?serial=${encodeURIComponent(serial)}`);
    if(!res.ok){ setWarn(`Erreur API (${res.status})`); return; }
    const data = await res.json();
    if(data.error){ setWarn('Erreur: '+data.error); return; }
    const series = data.series||{};
    const colors = ['black','cyan','magenta','yellow'];
    const dateSet = new Set();
    colors.forEach(c=>(series[c]||[]).forEach(p=>dateSet.add(p.date)));
    const labels = Array.from(dateSet).sort();
    if(!labels.length){ setWarn('Aucun historique KPAX trouv√© pour cette imprimante.'); return; }
    const COLOR_MAP = { black:'rgb(200,200,210)', cyan:'rgb(0,174,239)', magenta:'rgb(236,0,140)', yellow:'rgb(234,179,8)' };
    const datasets = colors.map(c=>{
      const m = new Map((series[c]||[]).map(p=>[p.date,p.pct]));
      return { label:c, data:labels.map(d=>m.has(d)?m.get(d):null), spanGaps:true, tension:0.25, pointRadius:2, borderColor:COLOR_MAP[c], backgroundColor:COLOR_MAP[c] };
    });
    const isDark = !document.documentElement.classList.contains('light');
    const gc = isDark?'rgba(255,255,255,0.07)':'rgba(0,0,0,0.07)';
    const tc = isDark?'#7a7f8e':'#6b7280';
    new Chart(document.getElementById('historyChart'),{
      type:'line', data:{labels,datasets},
      options:{ responsive:true, plugins:{legend:{display:true,labels:{color:tc,boxWidth:12,font:{size:12}}}},
        scales:{ x:{ticks:{color:tc,maxTicksLimit:10,font:{size:11}},grid:{color:gc}}, y:{beginAtZero:true,suggestedMax:100,ticks:{color:tc},grid:{color:gc}} } }
    });
    setWarn(null);
  }catch(e){ setWarn('Erreur JS: '+(e?.message||e)); }
}
loadHistory();
</script>
</body>
</html>